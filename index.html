<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemilihan Ketua & Wakil Ketua OSIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Gaya dasar terinspirasi dari MacOS */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            background-image: url('https://images.unsplash.com/photo-1534447677768-be436a0976f2?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            overflow-x: hidden;
        }
        .macos-window {
            background-color: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(209, 213, 219, 0.6);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        .traffic-lights {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            gap: 8px;
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }
        .dot-red { background-color: #FF5F56; }
        .dot-yellow { background-color: #FFBD2E; }
        .dot-green { background-color: #27C93F; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center; z-index: 50;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1; visibility: visible;
        }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-7xl mx-auto">

        <!-- ===== HALAMAN LOGIN ===== -->
        <div id="login-page" class="w-full max-w-md mx-auto">
            <div class="macos-window p-8 pt-12 relative">
                <div class="traffic-lights">
                    <div class="dot dot-red"></div>
                    <div class="dot dot-yellow"></div>
                    <div class="dot dot-green"></div>
                </div>
                <h2 class="text-center text-2xl font-bold text-gray-800 mb-2">Portal Pemilihan</h2>
                <p class="text-center text-gray-600 mb-8">Gunakan hak suaramu secara bijak.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="email" class="text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" class="mt-1 block w-full px-4 py-2 bg-white/80 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" autocomplete="email">
                    </div>
                    <!-- Bagian Password dengan Ikon Mata -->
                    <div class="relative">
                        <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" class="mt-1 block w-full pl-4 pr-10 py-2 bg-white/80 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition" autocomplete="current-password">
                        <button type="button" id="password-toggle-btn" class="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-gray-500 hover:text-gray-700 focus:outline-none">
                            <!-- Ikon Mata Terbuka -->
                            <svg id="eye-icon" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                            </svg>
                            <!-- Ikon Mata Tertutup (Tercoret) -->
                            <svg id="eye-slash-icon" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" />
                                <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.742L2.303 6.546A10.048 10.048 0 01.458 10c1.274 4.057 5.022 7 9.542 7 1.126 0 2.206-.234 3.2-.65l-1.446-1.447a6.996 6.996 0 00-1.246.143z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button id="login-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                        Masuk
                    </button>
                </div>
                 <p id="user-id-display" class="mt-4 text-xs text-center text-gray-400 break-all"></p>
            </div>
        </div>

        <!-- ===== HALAMAN VOTING ===== -->
        <div id="voting-page" class="hidden">
             <div class="macos-window p-6 md:p-8 relative">
                <div class="traffic-lights"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Pilih Kandidatmu</h2>
                    <button id="logout-btn-vote" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Keluar</button>
                </div>
                <div id="info-message-container" class="mb-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 rounded-r-lg hidden"><p id="info-message-text"></p></div>
                <div id="candidate-list-vote" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="vote-actions" class="mt-8 pt-6 border-t border-gray-300 flex-col md:flex-row flex justify-end gap-4 hidden">
                    <p id="selected-candidate-info" class="text-gray-700 font-medium text-center md:text-left flex-grow">Pilih seorang kandidat untuk melanjutkan.</p>
                    <button id="cancel-vote-btn" class="w-full md:w-auto bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-400 transition">Batalkan</button>
                    <button id="confirm-vote-btn" class="w-full md:w-auto bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition" disabled>Lanjutkan</button>
                </div>
                <div class="mt-8 text-center"><button id="view-results-btn" class="hidden bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Lihat Hasil</button></div>
            </div>
        </div>

        <!-- ===== HALAMAN HASIL ===== -->
        <div id="results-page" class="hidden">
             <div class="macos-window p-6 md:p-8 relative">
                 <div class="traffic-lights"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Hasil Perolehan Suara</h2>
                    <button id="back-to-vote-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Kembali</button>
                </div>
                <p class="text-center text-gray-600 mb-8">Hasil berikut diperbarui secara real-time.</p>
                <div id="candidate-list-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
        
        <!-- ===== HALAMAN ADMIN ===== -->
        <div id="admin-page" class="hidden">
             <div class="macos-window p-6 md:p-8 relative">
                <div class="traffic-lights"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Dasbor Admin</h2>
                    <button id="logout-btn-admin" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Keluar</button>
                </div>
                <div class="bg-white/80 p-6 rounded-xl mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Pengaturan Aplikasi</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="admin-info-message" class="block text-sm font-medium text-gray-700">Pesan Informasi</label>
                            <textarea id="admin-info-message" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Tampilkan "Lihat Hasil" untuk Pemilih</span>
                            <label for="toggle-results" class="inline-flex relative items-center cursor-pointer">
                                <input type="checkbox" id="toggle-results" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                         <button id="save-settings-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Simpan Pengaturan</button>
                    </div>
                </div>
                <div class="bg-white/80 p-6 rounded-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Manajemen Kandidat</h3>
                    <div id="admin-candidate-list" class="space-y-4 mb-6"></div>
                    <button id="add-candidate-form-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">Tambah Kandidat Baru</button>
                </div>
             </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    <div id="modal-vote-confirm" class="modal-overlay">
        <div class="macos-window w-full max-w-sm p-8 pt-12 relative text-center">
            <div class="traffic-lights"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Konfirmasi Pilihan</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin? Tindakan ini tidak dapat diurungkan.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-vote-cancel-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Batal</button>
                <button id="modal-vote-confirm-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Ya, Saya Yakin</button>
            </div>
        </div>
    </div>
    <div id="modal-delete-confirm" class="modal-overlay">
        <div class="macos-window w-full max-w-sm p-8 pt-12 relative text-center">
            <div class="traffic-lights"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Hapus Kandidat?</h3>
            <p class="text-gray-600 mb-6">Tindakan ini akan menghapus kandidat secara permanen. Anda yakin?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-delete-cancel-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Batal</button>
                <button id="modal-delete-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Ya, Hapus</button>
            </div>
        </div>
    </div>
    <div id="modal-alert" class="modal-overlay">
        <div class="macos-window w-full max-w-sm p-8 pt-12 relative text-center">
            <div class="traffic-lights"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>
            <h3 id="alert-title" class="text-xl font-bold text-gray-800 mb-4">Informasi</h3>
            <p id="alert-message" class="text-gray-600 mb-6">Pesan alert.</p>
            <div class="flex justify-center"><button id="alert-ok-btn" class="bg-blue-600 text-white font-semibold py-2 px-8 rounded-lg hover:bg-blue-700 transition">OK</button></div>
        </div>
    </div>
    <div id="modal-candidate-form" class="modal-overlay">
        <div class="macos-window w-full max-w-lg p-8 pt-12 relative">
             <div class="traffic-lights"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>
            <h3 id="candidate-form-title" class="text-xl font-bold text-gray-800 mb-6">Tambah Kandidat</h3>
            <form id="candidate-form" class="space-y-4">
                <input type="hidden" id="candidate-id">
                <div><label for="candidate-name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label><input type="text" id="candidate-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required></div>
                <div><label for="candidate-number" class="block text-sm font-medium text-gray-700">Nomor Urut</label><input type="number" id="candidate-number" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required></div>
                <div><label for="candidate-photo" class="block text-sm font-medium text-gray-700">URL Foto</label><input type="url" id="candidate-photo" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required></div>
                <div><label for="candidate-visi" class="block text-sm font-medium text-gray-700">Visi</label><textarea id="candidate-visi" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required></textarea></div>
                <div><label for="candidate-misi" class="block text-sm font-medium text-gray-700">Misi</label><textarea id="candidate-misi" rows="5" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required></textarea></div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="candidate-form-cancel" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, addDoc, writeBatch, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDYc5nc-ZnTyza4lIFFBBzE2l0U2T-bdrM",
            authDomain: "pemilossmaba.firebaseapp.com",
            projectId: "pemilossmaba",
            storageBucket: "pemilossmaba.appspot.com",
            messagingSenderId: "440944032139",
            appId: "1:440944032139:web:a9c53c121940235cd0578e",
            measurementId: "G-1YLVHKH3NV"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'osis-election-app';
        
        // --- INITIALIZE FIREBASE ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error initializing Firebase. Please check your firebaseConfig.", e);
            document.body.innerHTML = `<div class="text-red-500 p-8">Error: Firebase configuration is invalid. Please check the console.</div>`;
        }

        // --- DATABASE PATHS ---
        const usersPath = `/artifacts/${appId}/public/data/users`;
        const candidatesPath = `/artifacts/${appId}/public/data/candidates`;
        const settingsPath = `/artifacts/${appId}/public/data/settings`;
        const settingsDocRef = doc(db, settingsPath, 'appConfig');

        // --- DOM ELEMENTS & APP STATE ---
        const pages = { login: document.getElementById('login-page'), voting: document.getElementById('voting-page'), results: document.getElementById('results-page'), admin: document.getElementById('admin-page') };
        const modals = { 
            voteConfirm: document.getElementById('modal-vote-confirm'),
            deleteConfirm: document.getElementById('modal-delete-confirm'),
            alert: document.getElementById('modal-alert'), 
            candidateForm: document.getElementById('modal-candidate-form') 
        };
        let currentUserInfo = null, candidatesData = [], appSettings = { resultsVisible: false, infoMessage: "" };
        let unsubscribeCandidates = () => {}, unsubscribeSettings = () => {};
        let selectedCandidateId = null, candidateIdToDelete = null;
        
        // --- UTILITY FUNCTIONS ---
        const showPage = (pageName) => {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            if (pages[pageName]) pages[pageName].classList.remove('hidden');
        };
        const showModal = (modalName) => modals[modalName]?.classList.add('show');
        const hideModal = (modalName) => modals[modalName]?.classList.remove('show');
        
        const showAlert = (title, message, onOk) => {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            showModal('alert');
            document.getElementById('alert-ok-btn').onclick = () => {
                hideModal('alert');
                if (onOk) onOk();
            };
        };

        const showCandidateForm = (candidate = null) => {
            document.getElementById('candidate-form').reset();
            document.getElementById('candidate-id').value = candidate ? candidate.id : '';
            document.getElementById('candidate-form-title').textContent = candidate ? 'Edit Kandidat' : 'Tambah Kandidat Baru';
            if (candidate) {
                document.getElementById('candidate-name').value = candidate.name;
                document.getElementById('candidate-number').value = candidate.number;
                document.getElementById('candidate-photo').value = candidate.photo;
                document.getElementById('candidate-visi').value = candidate.visi;
                document.getElementById('candidate-misi').value = candidate.misi;
            }
            showModal('candidateForm');
        };
        
        // --- RENDER FUNCTIONS ---
        const renderVotingPage = () => {
            const container = document.getElementById('candidate-list-vote');
            container.innerHTML = '';
            const sortedCandidates = [...candidatesData].sort((a, b) => a.number - b.number);
            
            sortedCandidates.forEach(candidate => {
                const card = document.createElement('div');
                card.className = `candidate-card bg-white/80 p-5 rounded-xl shadow-md transition-all duration-300 border-4 border-transparent hover:shadow-xl hover:-translate-y-1`;
                card.dataset.id = candidate.id;
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-600 text-white w-12 h-12 flex items-center justify-center rounded-full text-2xl font-bold mr-4">${candidate.number}</div>
                        <h3 class="text-xl font-bold text-gray-800">${candidate.name}</h3>
                    </div>
                    <img src="${candidate.photo}" alt="Foto ${candidate.name}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/64748b?text=Foto+Kandidat';">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-1">Visi:</h4>
                        <p class="text-gray-600 text-sm mb-3">${candidate.visi}</p>
                        <h4 class="font-semibold text-gray-700 mb-1">Misi:</h4>
                        <p class="text-gray-600 text-sm">${candidate.misi.replace(/\n/g, '<br>')}</p>
                    </div>
                    <button data-id="${candidate.id}" class="vote-btn mt-4 w-full bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 transition">COBLOS</button>
                `;
                container.appendChild(card);
            });
            
            const infoContainer = document.getElementById('info-message-container');
            if (appSettings.infoMessage) {
                document.getElementById('info-message-text').textContent = appSettings.infoMessage;
                infoContainer.classList.remove('hidden');
            } else {
                infoContainer.classList.add('hidden');
            }
        };

        const renderResultsPage = () => {
            const container = document.getElementById('candidate-list-results');
            container.innerHTML = '';
            const totalVotes = candidatesData.reduce((sum, c) => sum + (c.voteCount || 0), 0);
            const sortedCandidates = [...candidatesData].sort((a, b) => (b.voteCount || 0) - (a.voteCount || 0));

            sortedCandidates.forEach(candidate => {
                const percentage = totalVotes > 0 ? (((candidate.voteCount || 0) / totalVotes) * 100).toFixed(1) : 0;
                const card = document.createElement('div');
                card.className = 'bg-white/80 p-5 rounded-xl shadow-md';
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-700 text-white w-12 h-12 flex items-center justify-center rounded-full text-2xl font-bold mr-4">${candidate.number}</div>
                        <h3 class="text-xl font-bold text-gray-800">${candidate.name}</h3>
                    </div>
                    <img src="${candidate.photo}" alt="Foto ${candidate.name}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/64748b?text=Foto+Kandidat';">
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-2xl text-blue-600">${percentage}%</span>
                            <span class="text-sm text-gray-600">${candidate.voteCount || 0} Suara</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-600 h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-center text-xs text-gray-500 mt-2">${percentage}% pemilih kandidat ini.</p>
                    </div>
                `;
                container.appendChild(card);
            });
        };
        
        const renderAdminPage = () => {
            document.getElementById('admin-info-message').value = appSettings.infoMessage || '';
            document.getElementById('toggle-results').checked = appSettings.resultsVisible || false;

            const container = document.getElementById('admin-candidate-list');
            container.innerHTML = '';
            const sortedCandidates = [...candidatesData].sort((a, b) => a.number - b.number);
            
            if (sortedCandidates.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Belum ada kandidat. Silakan tambahkan.</p>`;
            }

            sortedCandidates.forEach(candidate => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-lg shadow flex items-center justify-between';
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold text-lg text-blue-600 mr-4">${candidate.number}.</span>
                        <div>
                            <p class="font-semibold text-gray-800">${candidate.name}</p>
                            <p class="text-xs text-gray-500">Suara: ${candidate.voteCount || 0}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${candidate.id}" class="edit-candidate-btn bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-id="${candidate.id}" class="delete-candidate-btn bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        };

        // --- AUTHENTICATION LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('user-id-display').textContent = `UID: ${user.uid}`;
                const idTokenResult = await getIdTokenResult(user);
                const isAdmin = idTokenResult.claims.admin === true;

                const userDocRef = doc(db, usersPath, user.uid);
                const userDoc = await getDoc(userDocRef);
                let hasVoted = userDoc.exists() ? userDoc.data().hasVoted : false;
                if (!userDoc.exists()) await setDoc(userDocRef, { email: user.email, hasVoted: false });

                currentUserInfo = { uid: user.uid, email: user.email, isAdmin, hasVoted };
                listenToData();

                if (isAdmin) {
                    showPage('admin');
                } else {
                    if (hasVoted) {
                        showAlert('Sudah Memilih', 'Anda sudah menggunakan hak suara Anda.', () => {
                             if (appSettings.resultsVisible) showPage('results');
                             else {
                                showAlert('Informasi', 'Halaman hasil belum dibuka oleh admin.');
                                showPage('voting'); 
                                document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true);
                             }
                        });
                    } else showPage('voting');
                }
            } else {
                currentUserInfo = null;
                if(unsubscribeCandidates) unsubscribeCandidates();
                if(unsubscribeSettings) unsubscribeSettings();
                showPage('login');
            }
        });

        const handleLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showAlert('Login Gagal', 'Email dan password tidak boleh kosong.');
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error.code);
                let message = "Terjadi kesalahan saat login.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = "Email atau password yang Anda masukkan salah.";
                }
                showAlert('Login Gagal', message);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                showAlert('Error', 'Gagal keluar.');
            }
        };

        // --- VOTING LOGIC ---
        const selectCandidate = (id) => {
            selectedCandidateId = id;
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.classList.remove('ring-4', 'ring-blue-500', 'scale-105');
                if (card.dataset.id === id) {
                    card.classList.add('ring-4', 'ring-blue-500', 'scale-105');
                }
            });
            const candidate = candidatesData.find(c => c.id === id);
            document.getElementById('selected-candidate-info').textContent = `Anda memilih: No. ${candidate.number} - ${candidate.name}`;
            document.getElementById('vote-actions').classList.remove('hidden');
            document.getElementById('confirm-vote-btn').disabled = false;
        };
        
        const cancelSelection = () => {
            selectedCandidateId = null;
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.classList.remove('ring-4', 'ring-blue-500', 'scale-105');
            });
            document.getElementById('vote-actions').classList.add('hidden');
            document.getElementById('confirm-vote-btn').disabled = true;
        };

        const submitVote = async () => {
            if (!selectedCandidateId || !currentUserInfo || currentUserInfo.hasVoted) return;

            try {
                const batch = writeBatch(db);
                const candidateRef = doc(db, candidatesPath, selectedCandidateId);
                const userRef = doc(db, usersPath, currentUserInfo.uid);
                
                const candidateDoc = await getDoc(candidateRef);
                const newVoteCount = (candidateDoc.data().voteCount || 0) + 1;
                batch.update(candidateRef, { voteCount: newVoteCount });

                batch.update(userRef, { hasVoted: true });
                
                await batch.commit();

                currentUserInfo.hasVoted = true;

                hideModal('voteConfirm');
                showAlert('Terima Kasih!', 'Suara Anda telah berhasil direkam.', () => {
                    if (appSettings.resultsVisible) {
                        showPage('results');
                    } else {
                        showPage('voting');
                        document.querySelectorAll('.vote-btn').forEach(b => {
                            b.disabled = true;
                            b.textContent = 'Telah Memilih';
                            b.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                            b.classList.add('bg-gray-400', 'cursor-not-allowed');
                        });
                        cancelSelection();
                    }
                });
            } catch (error) {
                console.error("Error submitting vote:", error);
                showAlert('Error', 'Gagal merekam suara.');
            }
        };
        
        // --- ADMIN LOGIC ---
        const saveSettings = async () => {
            const newSettings = {
                infoMessage: document.getElementById('admin-info-message').value,
                resultsVisible: document.getElementById('toggle-results').checked,
            };
            try {
                await setDoc(settingsDocRef, newSettings, { merge: true });
                showAlert('Sukses', 'Pengaturan berhasil disimpan.');
            } catch (error) {
                console.error("Error saving settings:", error);
                showAlert('Error', 'Gagal menyimpan pengaturan.');
            }
        };
        
        const saveCandidate = async (event) => {
            event.preventDefault();
            const id = document.getElementById('candidate-id').value;
            const candidateData = {
                name: document.getElementById('candidate-name').value,
                number: parseInt(document.getElementById('candidate-number').value, 10),
                photo: document.getElementById('candidate-photo').value,
                visi: document.getElementById('candidate-visi').value,
                misi: document.getElementById('candidate-misi').value,
            };

            try {
                if (id) {
                    await updateDoc(doc(db, candidatesPath, id), candidateData);
                } else {
                    candidateData.voteCount = 0;
                    await addDoc(collection(db, candidatesPath), candidateData);
                }
                hideModal('candidateForm');
                showAlert('Sukses', `Kandidat berhasil ${id ? 'diperbarui' : 'ditambahkan'}.`);
            } catch (error) {
                console.error("Error saving candidate:", error);
                showAlert('Error', 'Gagal menyimpan data kandidat.');
            }
        };
        
        const requestDeleteCandidate = (id) => {
            candidateIdToDelete = id;
            showModal('deleteConfirm');
        };
        
        const executeDeleteCandidate = async () => {
            if (!candidateIdToDelete) return;
            try {
                await deleteDoc(doc(db, candidatesPath, candidateIdToDelete));
                showAlert('Sukses', 'Kandidat berhasil dihapus.');
            } catch (error) {
                console.error("Error deleting candidate:", error);
                showAlert('Error', 'Gagal menghapus kandidat.');
            } finally {
                candidateIdToDelete = null;
                hideModal('deleteConfirm');
            }
        };

        // --- REAL-TIME DATA LISTENERS ---
        const listenToData = () => {
            if(unsubscribeCandidates) unsubscribeCandidates();
            unsubscribeCandidates = onSnapshot(query(collection(db, candidatesPath)), (snapshot) => {
                candidatesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!pages.voting.classList.contains('hidden')) renderVotingPage();
                if (!pages.results.classList.contains('hidden')) renderResultsPage();
                if (!pages.admin.classList.contains('hidden')) renderAdminPage();
            });

            if(unsubscribeSettings) unsubscribeSettings();
            unsubscribeSettings = onSnapshot(settingsDocRef, (doc) => {
                if (doc.exists()) {
                    appSettings = doc.data();
                } else {
                    setDoc(settingsDocRef, { resultsVisible: false, infoMessage: "" });
                }
                const viewResultsBtn = document.getElementById('view-results-btn');
                if (appSettings.resultsVisible) viewResultsBtn.classList.remove('hidden');
                else viewResultsBtn.classList.add('hidden');
                
                if (!pages.admin.classList.contains('hidden')) renderAdminPage();
                if (!pages.voting.classList.contains('hidden')) renderVotingPage();
            });
        };

        // --- EVENT LISTENERS ---
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn-vote').addEventListener('click', handleLogout);
        document.getElementById('logout-btn-admin').addEventListener('click', handleLogout);
        document.getElementById('back-to-vote-btn').addEventListener('click', () => {
             if (currentUserInfo?.isAdmin) showPage('admin'); else showPage('voting');
        });
        document.getElementById('candidate-list-vote').addEventListener('click', (e) => {
            const voteButton = e.target.closest('.vote-btn');
            if (voteButton && !voteButton.disabled) selectCandidate(voteButton.dataset.id);
        });
        document.getElementById('cancel-vote-btn').addEventListener('click', cancelSelection);
        document.getElementById('confirm-vote-btn').addEventListener('click', () => { if (selectedCandidateId) showModal('voteConfirm'); });
        document.getElementById('view-results-btn').addEventListener('click', () => showPage('results'));
        
        // Modal Buttons
        document.getElementById('modal-vote-cancel-btn').addEventListener('click', () => hideModal('voteConfirm'));
        document.getElementById('modal-vote-confirm-btn').addEventListener('click', submitVote);
        document.getElementById('modal-delete-cancel-btn').addEventListener('click', () => hideModal('deleteConfirm'));
        document.getElementById('modal-delete-confirm-btn').addEventListener('click', executeDeleteCandidate);

        // Admin Page Buttons
        document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        document.getElementById('add-candidate-form-btn').addEventListener('click', () => showCandidateForm());
        document.getElementById('admin-candidate-list').addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-candidate-btn');
            const deleteBtn = e.target.closest('.delete-candidate-btn');
            if(editBtn) showCandidateForm(candidatesData.find(c => c.id === editBtn.dataset.id));
            if(deleteBtn) requestDeleteCandidate(deleteBtn.dataset.id);
        });
        
        // Candidate Form Buttons
        document.getElementById('candidate-form').addEventListener('submit', saveCandidate);
        document.getElementById('candidate-form-cancel').addEventListener('click', () => hideModal('candidateForm'));
        
        // Password Toggle Button
        const passwordInput = document.getElementById('password');
        const passwordToggleBtn = document.getElementById('password-toggle-btn');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeSlashIcon = document.getElementById('eye-slash-icon');

        passwordToggleBtn.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeSlashIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeSlashIcon.classList.add('hidden');
            }
        });

        // --- APP INITIALIZATION ---
        window.onload = () => {
            if (!db) return; // Stop if Firebase failed to initialize
            showPage('login');
        };

    </script>
</body>
</html>
